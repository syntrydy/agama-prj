Flow agama.saml
     Basepath ""
     Timeout 500 seconds
     Configs kcConf
// Calling SAML service
Log "@info Calling SAML service"
// Log kcConf properties
Log "@info " kcConf.serverUrl kcConf.realm kcConf.clientId
// Create instance of SamlService
samlService | ex = Call org.gluu.agama.saml.service.SamlService#new kcConf.serverUrl  kcConf.realm  kcConf.clientId  kcConf.clientSecret  kcConf.grantType  kcConf.scope  kcConf.username  kcConf.password  kcConf.spMetadataUrl  kcConf.tokenUrl  kcConf.idpUrl kcConf.extIDPTokenUrl
// Log samlService instance
Log "@info " samlService
// Get All IDP Details
idpMap | ex = Call samlService getIdps 
// Log IDP Map
Log "@info " idpMap
// Display SAML IDP Discovery Page
extIdpData = RRF "saml-idp-discovery.ftlh" idpMap
// Log extIdpData.extIdpRedirectUrl
Log "@info " extIdpData.extIdp
idpData = Call samlService getIdpData extIdpData.extIdp
// Log idpData
Log "@info " idpData.idpUrl
// Redirect to External IDP 
samlResponse = RFAC idpData.idpUrl
// Log external IDP result
Log "@info " samlResponse
// Create user if not present
uid | ex = Call UserHelperService#exec "puja"
// Finish with uid
Finish uid